{% extends 'base.html' %}
{% load static %}
{% load colaborador_tags %}

{% block title %}{{ posts.titulo }} | Smart Cities{% endblock title %}

{% block contenido %}

<div class="container my-5 pt-5">
    <div class="row justify-content-center">
        <div class="col-lg-9">

            <header class="mb-5 text-center">
                <span class="badge rounded-pill bg-primary text-uppercase px-3 py-2 mb-3 shadow-sm">
                    <i class="ti-tag me-1"></i> {{ posts.categoria }}
                </span>

                <h1 class="fw-bolder mb-3 text-dark display-4">{{ posts.titulo }}</h1>

                {% if posts.subtitulo %}
                <h4 class="text-muted fw-normal mb-4 px-md-5">{{ posts.subtitulo }}</h4>
                {% endif %}

                <div
                    class="d-flex justify-content-center align-items-center text-muted small border-top border-bottom py-3 mt-4">
                    <div class="px-3 border-end">
                        <i class="ti-user text-primary me-1"></i> Por <strong>Jorge Subeldia</strong>
                    </div>
                    <div class="px-3">
                        <i class="ti-calendar text-primary me-1"></i> {{ posts.fecha|date:"d \d\e F, Y" }}
                    </div>
                </div>
            </header>

            {% if posts.imagen %}
            <figure class="mb-5 shadow-lg rounded-lg overflow-hidden position-relative">
                <img class="img-fluid w-100" src="{{ posts.imagen.url }}" alt="{{ posts.titulo }}"
                    style="max-height: 500px; object-fit: cover;">

                {% if posts.pie_foto %}
                <figcaption class="bg-dark text-white p-3 text-center small opacity-75">
                    <i class="ti-image me-2"></i> {{ posts.pie_foto }}
                </figcaption>
                {% endif %}
            </figure>
            {% endif %}

            <article class="mb-5 text-dark post-body" style="font-size: 1.2rem; line-height: 2; text-align: justify;">
                {{ posts.texto|safe }}
            </article>

            <div class="row g-3 pb-5 border-bottom">
                <div
                    class="col-md-{% if user.is_superuser or request.user|has_group:'Colaborador' %}4{% else %}12{% endif %} d-grid">
                    <a class="btn btn-primary btn-lg btn-rounded shadow"
                        href="{% url 'apps.comentario:comentar_post' id=posts.pk %}">
                        <i class="ti-comment-alt me-2"></i>Escribir un comentario
                    </a>
                </div>

                {% if user.is_superuser or request.user|has_group:"Colaborador" %}
                <div class="col-md-4 d-grid">
                    <a href="{% url 'apps.posts:post_form' pk=posts.pk %}"
                        class="btn btn-outline-dark btn-lg btn-rounded">
                        <i class="ti-pencil-alt me-2"></i>Editar noticia
                    </a>
                </div>
                <div class="col-md-4 d-grid">
                    <a href="{% url 'apps.posts:post_eliminar' pk=posts.pk %}"
                        class="btn btn-outline-danger btn-lg btn-rounded">
                        <i class="ti-trash me-2"></i>Eliminar
                    </a>
                </div>
                {% endif %}
            </div>

            <section class="comments-section mt-5">
    <h3 class="fw-bold mb-4 d-flex align-items-center">
        <i class="ti-comments text-primary me-3"></i> Comentarios
        <span class="badge bg-light text-primary ms-2 border small">{{ posts.comentarios.count }}</span>
    </h3>

    {% for c in posts.comentarios.all %}
    <div class="card shadow-sm border-0 bg-white mb-4 rounded-lg overflow-hidden">
        <div class="card-body p-4">
            <div class="d-flex gap-3 align-items-start">
                
                <div class="rounded-circle flex-shrink-0 shadow-sm overflow-hidden border border-2 border-primary" style="width:60px; height: 60px;">
                    {% if c.usuario.imagen %}
                        <img src="{{ c.usuario.imagen.url }}" style="width: 100%; height: 100%; object-fit: cover;">
                    {% else %}
                        <img src="/media/usuario/usuario_por_defecto.jpg" alt="Usuario" style="width: 100%; height: 100%; object-fit: cover;">
                    {% endif %}
                </div>

                <div class="w-100">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0 fw-bold text-dark">{{ c.usuario.username }}</h6>
                        
                        <small class="text-muted">
                            <i class="ti-time me-1"></i>
                            {% if c.fecha_creacion %}
                                {{ c.fecha_creacion|date:"d/m/Y H:i" }}
                            {% elif c.fecha %}
                                {{ c.fecha|date:"d/m/Y H:i" }}
                            {% else %}
                                Recién publicado
                            {% endif %}
                        </small>
                    </div>
                    <p class="text-muted mb-0" style="text-align: justify;">{{ c.texto }}</p>

                    {% if user.is_superuser %}
                    <div class="text-end mt-3">
                        <a class="btn btn-sm btn-outline-danger border-0"
                            href="{% url 'apps.comentario:eliminarComentario' c.pk %}">
                            <i class="ti-trash me-1"></i> Borrar
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% empty %}
    <div class="text-center py-5 bg-light rounded-lg">
        <i class="ti-comment text-muted mb-3" style="font-size: 3rem; display: block;"></i>
        <p class="text-muted">Aún no hay comentarios. ¡Sé el primero en compartir tu opinión!</p>
    </div>
    {% endfor %}
</section>

        </div>
    </div>
</div>

<style>
    .rounded-lg {
        border-radius: 1rem !important;
    }

    .post-body p {
        margin-bottom: 1.5rem;
    }

    .btn-rounded {
        border-radius: 50px !important;
    }
</style>

{% endblock %}